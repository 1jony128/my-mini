# ðŸš€ ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ñ AI Ð»Ð¾Ð³Ð¸ÐºÐ¸ Ð² Supabase Functions

## ðŸ“‹ Ð§Ñ‚Ð¾ Ð±Ñ‹Ð»Ð¾ ÑÐ´ÐµÐ»Ð°Ð½Ð¾:

### 1. **Ð¡Ð¾Ð·Ð´Ð°Ð½Ð° Supabase Edge Function**
- `supabase/functions/ai-chat/index.ts` - Ñ†ÐµÐ½Ñ‚Ñ€Ð°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° AI Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
- ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Ð²ÑÐµÑ… Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹ Ñ fallback Ð»Ð¾Ð³Ð¸ÐºÐ¾Ð¹
- ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð² Ð‘Ð”
- ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒ Ð»Ð¸Ð¼Ð¸Ñ‚Ð¾Ð² Ð¸ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð²

### 2. **SQL Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð²**
- `increment_daily_tokens()` - Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð²
- `reset_daily_tokens()` - ÑÐ±Ñ€Ð¾Ñ ÐµÐ¶ÐµÐ´Ð½ÐµÐ²Ð½Ñ‹Ñ… Ð»Ð¸Ð¼Ð¸Ñ‚Ð¾Ð²
- `get_user_token_stats()` - Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ

### 3. **ÐÐ¾Ð²Ð°Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ°Ñ API**
- `src/api/ai-chat.ts` - Ð¾Ð±ÐµÑ€Ñ‚ÐºÐ¸ Ð´Ð»Ñ Ð²Ñ‹Ð·Ð¾Ð²Ð° Supabase Functions
- ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° streaming Ð¸ Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ñ… Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²
- ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ñ Ñ‡ÐµÑ€ÐµÐ· Supabase tokens

## ðŸ”§ Ð¨Ð°Ð³Ð¸ Ð´Ð»Ñ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ:

### **Ð¨Ð°Ð³ 1: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ**

Ð’ Supabase Dashboard â†’ Settings â†’ Edge Functions â†’ Environment Variables:

```bash
OPENROUTER_API_KEY=sk-or-v1-Ð²Ð°Ñˆ-ÐºÐ»ÑŽÑ‡
GROK_API_KEY=xai-Ð²Ð°Ñˆ-ÐºÐ»ÑŽÑ‡
SUPABASE_URL=https://Ð²Ð°Ñˆ-Ð¿Ñ€Ð¾ÐµÐºÑ‚.supabase.co
SUPABASE_SERVICE_ROLE_KEY=Ð²Ð°Ñˆ-service-role-ÐºÐ»ÑŽÑ‡
```

### **Ð¨Ð°Ð³ 2: Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ SQL Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¹**

```bash
# ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Supabase
supabase link --project-ref Ð²Ð°Ñˆ-project-id

# ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹
supabase db push
```

### **Ð¨Ð°Ð³ 3: Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Edge Function**

```bash
# Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ AI Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸
supabase functions deploy ai-chat

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ
supabase functions list
```

### **Ð¨Ð°Ð³ 4: ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¾Ð³Ð¾ ÐºÐ¾Ð´Ð°**

Ð—Ð°Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð²Ñ‹Ð·Ð¾Ð²Ñ‹ Ð² `ChatPage.tsx`:

```typescript
// Ð¡Ð¢ÐÐ Ð«Ð™ ÐšÐžÐ”:
// import { sendChatMessage } from '@/api/chat'

// ÐÐžÐ’Ð«Ð™ ÐšÐžÐ”:
import { sendAIMessageStream, checkModelAvailability } from '@/api/ai-chat'
```

### **Ð¨Ð°Ð³ 5: Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ**

1. **Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ:**
```bash
supabase functions serve ai-chat
```

2. **Ð¢ÐµÑÑ‚ API Ñ‡ÐµÑ€ÐµÐ· curl:**
```bash
curl -X POST https://Ð²Ð°Ñˆ-Ð¿Ñ€Ð¾ÐµÐºÑ‚.supabase.co/functions/v1/ai-chat \
  -H "Authorization: Bearer Ð²Ð°Ñˆ-access-token" \
  -H "Content-Type: application/json" \
  -d '{
    "messages": [{"role": "user", "content": "Hello"}],
    "model": "deepseek",
    "chatId": "test-chat",
    "stream": false
  }'
```

## ðŸŽ¯ ÐŸÑ€ÐµÐ¸Ð¼ÑƒÑ‰ÐµÑÑ‚Ð²Ð° Ð½Ð¾Ð²Ð¾Ð¹ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ñ‹:

### **ðŸ”’ Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ:**
- API ÐºÐ»ÑŽÑ‡Ð¸ ÑÐºÑ€Ñ‹Ñ‚Ñ‹ Ð² Supabase Environment
- ÐÐµÑ‚ Ð¿Ñ€ÑÐ¼Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° Ðº AI ÑÐµÑ€Ð²Ð¸ÑÐ°Ð¼
- Ð¦ÐµÐ½Ñ‚Ñ€Ð°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ñ

### **âš¡ ÐŸÑ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ:**
- Ð£Ð¼Ð½Ñ‹Ðµ fallbacks Ð¼ÐµÐ¶Ð´Ñƒ Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€Ð°Ð¼Ð¸
- ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ‚Ð¾ÐºÐµÐ½Ð°Ð¼Ð¸
- ÐšÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð² Supabase

### **ðŸ›  Ð£Ð´Ð¾Ð±ÑÑ‚Ð²Ð¾ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸:**
- Ð•Ð´Ð¸Ð½Ð°Ñ Ñ‚Ð¾Ñ‡ÐºÐ° Ð²Ñ…Ð¾Ð´Ð° Ð´Ð»Ñ Ð²ÑÐµÑ… AI Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
- Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð² Supabase
- Ð›ÐµÐ³ÐºÐ¾Ðµ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð½Ð¾Ð²Ñ‹Ñ… Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹

### **ðŸ’° Ð­ÐºÐ¾Ð½Ð¾Ð¼Ð¸Ñ:**
- ÐžÐ¿Ñ‚Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ API ÐºÐ²Ð¾Ñ‚
- ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð²Ñ‹Ð±Ð¾Ñ€ Ð´ÐµÑˆÐµÐ²Ñ‹Ñ… fallback Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹
- ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒ Ñ€Ð°ÑÑ…Ð¾Ð´Ð¾Ð² Ñ‡ÐµÑ€ÐµÐ· Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹

## ðŸ”„ ÐŸÐ»Ð°Ð½ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸:

### **Ð¤Ð°Ð·Ð° 1: ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° (âœ… Ð“Ð¾Ñ‚Ð¾Ð²Ð¾)**
- [x] Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Supabase Function
- [x] SQL Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð²  
- [x] ÐÐ¾Ð²Ð°Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ°Ñ API

### **Ð¤Ð°Ð·Ð° 2: Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ**
- [ ] ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° environment variables
- [ ] Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ SQL Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹
- [ ] Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Edge Function

### **Ð¤Ð°Ð·Ð° 3: Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ**
- [ ] ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ChatPage
- [ ] Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð²ÑÐµÑ… Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹
- [ ] ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° fallback Ð»Ð¾Ð³Ð¸ÐºÐ¸

### **Ð¤Ð°Ð·Ð° 4: ÐžÑ‡Ð¸ÑÑ‚ÐºÐ°**
- [ ] Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ€Ñ‹Ñ… API Ñ„Ð°Ð¹Ð»Ð¾Ð²
- [ ] ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸
- [ ] Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ

## ðŸ†˜ Troubleshooting:

### **ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°: Function Ð½Ðµ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ÑÑ**
```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ
deno check supabase/functions/ai-chat/index.ts

# ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð»Ð¾Ð³Ð¸
supabase functions logs ai-chat
```

### **ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°: ÐÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Environment Variables**
```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ
supabase secrets list

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ
supabase secrets set OPENROUTER_API_KEY=your-key
```

### **ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°: Streaming Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚**
- Ð£Ð±ÐµÐ´Ð¸Ñ‚ÑŒÑÑ Ñ‡Ñ‚Ð¾ `Content-Type: text/event-stream`
- ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ CORS Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
- ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ SSE Ð´Ð°Ð½Ð½Ñ‹Ñ…

## ðŸ“Š ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³:

### **Ð›Ð¾Ð³Ð¸ Edge Function:**
```bash
supabase functions logs ai-chat --follow
```

### **Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ:**
```sql
SELECT 
  model,
  COUNT(*) as requests,
  AVG(tokens_used) as avg_tokens
FROM messages 
WHERE created_at > NOW() - INTERVAL '24 hours'
GROUP BY model;
```

### **ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¾ÑˆÐ¸Ð±Ð¾Ðº:**
```sql
SELECT * FROM edge_logs 
WHERE level = 'error' 
AND timestamp > NOW() - INTERVAL '1 hour';
```
